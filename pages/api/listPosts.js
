import { supabase } from '../../lib/supabaseClient'

export default async function handler(req, res){
  if (req.method !== 'GET') return res.status(405).end()
  const { data, error } = await supabase
    .from('posts')
    .select(`id, title, body, image_url, created_at, likes, author_id`)
    .order('created_at', {ascending:false})
    .limit(100)
  if (error) return res.status(500).json({ error: error.message })
  // attach author names
  const authorIds = Array.from(new Set(data.map(p=>p.author_id).filter(Boolean)))
  const { data: profiles } = await supabase.from('profiles').select('user_id, name').in('user_id', authorIds)
  const map = Object.fromEntries((profiles||[]).map(r=>[r.user_id, r.name]))
  const posts = data.map(p=>({ ...p, author_name: map[p.author_id] || 'Unknown' }))
  res.json({ posts })
}